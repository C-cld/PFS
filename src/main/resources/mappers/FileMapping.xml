<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cyy.dao.FileMapper">
    <insert id="addFile" parameterType="com.cyy.domain.UploadFile">
        insert into upload_file (id, original_name, name, size, create_date, deleted) values (#{id}, #{originalName}, #{name}, round(#{size},2), now(), 0)
    </insert>

    <insert id="fileToTag" parameterType="com.cyy.domain.FileToTag">
        insert into file_to_tag (id, file_id, tag_id, create_date) values (#{id}, #{fileId}, #{tagId}, now())
    </insert>

    <insert id="addTag" parameterType="com.cyy.domain.Tag">
        insert into tag (id, name, create_date) values (#{id}, #{name}, now())
    </insert>

    <select id="findTag" resultType="com.cyy.domain.Tag">
        select id, name, create_date as createDate from tag where deleted = 0
    </select>

    <select id="findFile" resultType="com.cyy.domain.UploadFile">
        select id, original_name as originalName, size, create_date as createDate, deleted from upload_file where deleted = 0
        <if test="tagIds != null and arrLength != 0">
            and id in (select file_id from (select file_id,count(*) as count from file_to_tag where
            <foreach item="tag_id" collection="tagIds" index="index">
                <if test="index == 0">
                    tag_id = #{tag_id}
                </if>
                <if test="index != 0">
                    or tag_id = #{tag_id}
                </if>
            </foreach>
            GROUP BY file_id having count = #{arrLength}) tmp)
        </if>
        limit #{index}, #{limit}
    </select>

    <update id="deleteVideo">
        update upload_file set deleted = 1 where id = #{videoId}
    </update>

    <delete id="deleteFileToTag">
        delete from file_to_tag where file_id = #{videoId}
    </delete>

    <update id="updateTagNameById">
        update tag set name = #{newTagName} where id = #{tagId}
    </update>

    <delete id="deleteTag">
        update tag set deleted = 1 where id = #{tagId}
    </delete>

    <select id="getTotal" resultType="java.lang.Integer">
        select count(*) from upload_file where deleted = 0
        <if test="tagIds != null and arrLength != 0">
            and id in (select file_id from (select file_id,count(*) as count from file_to_tag where
            <foreach item="tag_id" collection="tagIds" index="index">
                <if test="index == 0">
                    tag_id = #{tag_id}
                </if>
                <if test="index != 0">
                    or tag_id = #{tag_id}
                </if>
            </foreach>
            GROUP BY file_id having count = #{arrLength}) tmp)
        </if>
    </select>
</mapper>