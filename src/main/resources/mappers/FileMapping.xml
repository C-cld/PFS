<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cyy.dao.FileMapper">
    <insert id="addFile" parameterType="com.cyy.domain.UploadFile">
        insert into upload_file (id, original_name, name, size, create_date) values (#{id}, #{originalName}, #{name}, round(#{size},2), now())
    </insert>

    <insert id="fileToTag" parameterType="com.cyy.domain.FileToTag">
        insert into file_to_tag (id, file_id, tag_id, create_date) values (#{id}, #{fileId}, #{tagId}, now())
    </insert>

    <insert id="addTag" parameterType="com.cyy.domain.Tag">
        insert into tag (id, name, create_date) values (#{id}, #{name}, now())
    </insert>

    <select id="findTag" resultType="com.cyy.domain.Tag">
        select id, name, create_date as createDate from tag
    </select>

    <select id="findFile" resultType="com.cyy.domain.UploadFile">
        select id, original_name as originalName, size, create_date as createDate from upload_file
        <if test="tagIds != null and arrLength != 0">
            where id in (select file_id from (select file_id,count(*) as count from file_to_tag where
            <foreach item="tag_id" collection="tagIds" index="index">
                <if test="index == 0">
                    tag_id = #{tag_id}
                </if>
                <if test="index != 0">
                    or tag_id = #{tag_id}
                </if>
            </foreach>
            GROUP BY file_id having count = #{arrLength}) tmp)
        </if>
    </select>
</mapper>