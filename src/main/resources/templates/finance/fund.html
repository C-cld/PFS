<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link th:href="@{/layui/css/layui.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/fund.css}" rel="stylesheet" type="text/css">
    <script type="text/javascript" th:src="@{/layui/layui.js}"></script>
    <script type="text/javascript" th:src="@{/js/echarts.min.js}"></script>
    <title>Title</title>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-row layui-col-space12">
        <div class="layui-col-md9">
            <div class="layui-card record-list">
                <div class="layui-form layui-card-header">
                    资金变动记录
                </div>
                <div class="layui-card-body">
                    <table class="layui-table" lay-data="{url:'/fund-investment-record', toolbar:'#addToolBar', defaultToolbar:['filter', 'exports', 'print'], page:true, id:'record-table'}" lay-filter="record-table">
                        <thead>
                        <tr>
                            <th lay-data="{field:'productId'}">基金代码</th>
                            <th lay-data="{field:'share'}">确认份额</th>
                            <th lay-data="{field:'net'}">确认净值</th>
                            <th lay-data="{field:'confirm'}">确认金额</th>
                            <th lay-data="{field:'serviceFee'}">手续费</th>
                            <th lay-data="{field:'createDate', templet:'#createDate'}">买入时间</th>
                        </tr>
                        </thead>
                    </table>
                    <script type="text/html" id="addToolBar">
                        <div class="layui-btn-container">
                            <button class="layui-btn layui-btn-sm" lay-event="addRecord">新增</button>
                        </div>
                    </script>
                    <script id="createDate" type="text/html">
                        {{#
                        var date = new Date();
                        date.setTime(d.createDate);
                        return date.Format("yyyy-MM-dd hh:mm:ss");
                        }}
                    </script>
                </div>
            </div>
        </div>
        <div class="layui-col-md3">
            <div class="layui-card">
                <div class="layui-card-header">
                    <div class="layui-form-item">
                        我的基金
                        <div class="layui-inline add-fund">
                            <button class="layui-btn layui-btn-sm layui-bg-gray addFund"><i class="layui-icon layui-icon-add-1"></i></button>
                        </div>
                    </div>
                </div>
                <div class="layui-card-body">
                    <div class="layui-carousel" id="fund-carousel" lay-filter="fund-carousel">
                        <div class="fund-item" carousel-item>
                            <div th:each="fund,fundStat : ${fundList}">
                                <div th:id="${fund.id}" style="width: 380px;height:280px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">
                    投资比重
                </div>
                <div class="layui-card-body">

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    layui.use(['table', 'element', 'carousel'], function() {
        var $ = layui.jquery;
        var layer = layui.layer;
        var table = layui.table;
        var element = layui.element;
        var carousel = layui.carousel;
        // 头工具栏事件（新增）
        table.on('toolbar(record-table)', function(obj){
            if (obj.event == 'addRecord') {
                layer.open({
                    type: 2,
                    title: '新增',
                    maxmin: true,
                    shade: 0,
                    content: '/fund-investment-record-add'
                });
            }
        });
        // 初始化轮播
        carousel.render({
            elem: '#fund-carousel',
            width: '100%',
            arrow: 'hover',
            autoplay: false
        });
        // 渲染第一个轮播内容
        paint($('.fund-item div').children(":first").attr("id"));
        // 轮播切换事件
        carousel.on('change(fund-carousel)', function (obj) {
            paint(obj.item[0].children[0].id);
        });
        // 添加基金
        $('.addFund').on('click', function(){
            var index = layer.open({
                type: 1,
                content: '<div class="layui-form-item">' +
                    '<input type="text" class="layui-input fund-code" placeholder="请输入基金代码" autofocus="autofocus">' +
                    '</div>',
                btn:['确定'],
                btn1: function () {
                    var fundCode = $('.fund-code').val();
                    $.ajax({
                        url: '/insert-fund?fundCode=' + fundCode,
                        success: function(result) {
                            if (result) {
                                location.reload();

                            } else {
                                layer.msg("新增失败");
                            }
                        }
                    });
                },
            });
        });
    });
    //对Date的扩展，将 Date 转化为指定格式的String
    //月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
    //年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
    //例子：
    //(new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
    //(new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18
    Date.prototype.Format = function(fmt) {
        var o = {
            "M+" : this.getMonth()+1,                 //月份
            "d+" : this.getDate(),                    //日
            "h+" : this.getHours(),                   //小时
            "m+" : this.getMinutes(),                 //分
            "s+" : this.getSeconds(),                 //秒
            "q+" : Math.floor((this.getMonth()+3)/3), //季度
            "S"  : this.getMilliseconds()             //毫秒
        };
        if(/(y+)/.test(fmt))
            fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));
        for(var k in o)
            if(new RegExp("("+ k +")").test(fmt))
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
        return fmt;
    }
</script>


<script th:inline="javascript">
    // 渲染图表
    function paint(fundCode) {
        var data = []; // echarts图表数据
        var markPointData = markPoint(fundCode); // 标记点
        var fundList = [[${fundList}]];
        var fundListLength = fundList.length;
        for (var i = 0; i < fundListLength; i++) {
            var fund = fundList[i]; //当前基金
            if (fund.id == fundCode) {
                var fundNet = fund.fundNet; // 当前基金的净值
                var fundNetLength = fundNet.length;
                // 将基金净值数据转化为echarts的格式
                for (var j = 0; j < fundNetLength; j++) {
                    data.push({
                        name: fundNet[j].ndate,
                        value: [fundNet[j].ndate, fundNet[j].net]
                    });
                }
                var myChart = echarts.init(document.getElementById(fundList[i].id));
                var option = {
                    title: {
                        text: fund.name
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            params = params[0];
                            var date = new Date(params.name);
                            return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ':' + params.value[1];
                        },
                        axisPointer: {
                            animation: false
                        }
                    },
                    xAxis: {
                        type: 'time',
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        type: 'value',
                        boundaryGap: [0, '100%'],
                        splitLine: {
                            show: true
                        }
                    },
                    series: [{
                        name: '基金净值',
                        type: 'line',
                        color: '#1E90FF',
                        showSymbol: false,
                        hoverAnimation: false,
                        data: data,
                        markPoint: {
                            symbol: 'circle',
                            symbolSize: 5,
                            label: {
                                show: false,
                            },
                            itemStyle: {
                                color: '#FF4500'
                            },
                            data: markPointData,
                        }
                    }]
                };
                myChart.setOption(option);
            }
        }
    }
    // 获取标记点
    function markPoint(fundCode) {
        var $ = layui.jquery;
        var markPointData = [];
        $.ajax({
            url: '/getMarkPoint?fundCode=' + fundCode,
            async: false, // 设为同步传输，既等success回调函数执行完才会继续往下执行
            success: function(result) {
                for (var j = 0; j < result.length; j++) {
                    markPointData.push({
                        name: result[j].net + '',
                        coord: [result[j].createDate, result[j].net]
                    });
                }
            }
        });
        return markPointData;
    }

</script>
</body>
</html>