<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link th:href="@{/layui/css/layui.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/profit.css}" rel="stylesheet" type="text/css">
    <script type="text/javascript" th:src="@{/layui/layui.js}"></script>
    <script type="text/javascript" th:src="@{/js/echarts.min.js}"></script>
    <title>Title</title>
</head>
<body>
    <div class="layui-fluid">
        <div class="layui-row layui-col-space12">
            <div class="layui-col-md7">
                <div class="layui-card">
                    <div class="layui-card-header" style="height:50px">
                        <form class="layui-form" action="">
                            <div class="layui-form-item" style="line-height:50px">
                                <div class="layui-inline">
                                    <input type="text" class="layui-input layui-input-inline" id="start-date" autocomplete="off">
                                    <div class="layui-form-mid">-</div>
                                    <input type="text" class="layui-input layui-input-inline" id="end-date" autocomplete="off">
                                </div>
                                <div class="layui-inline">
                                    <select id="category"  lay-filter="categories">
                                        <option value=""></option>
                                        <option value="010">股票</option>
                                        <option value="021" >基金</option>
                                        <option value="0571">黄金</option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="layui-card-body">
                        <div class="layui-row">
                            <div id="curve" style="height:400px;"></div>
                        </div>
                        <div class="layui-row layui-col-space12">
                            <div class="layui-col-md4">
                                <div class="current-month-profit">
                                    <div class="layui-row current-month-profit-head">当月收益</div>
                                </div>
                            </div>
                            <div class="layui-col-md8">
                                <div id="bar" style="height:394px;"></div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md5">

            </div>
        </div>
    </div>
    <script>
        layui.use(["form","table","laydate"], function(){
            var $ = layui.jquery;
            var form = layui.form;
            var table = layui.table;
            var laydate = layui.laydate;

            laydate.render({
                elem: '#start-date',
                done: function() {
                    // 加载收益曲线
                    paintCurve();
                    // 加载月柱状图
                    paintBar();
                }
            });
            laydate.render({
                elem: '#end-date',
                done: function() {
                    // 加载收益曲线
                    paintCurve();
                    // 加载月柱状图
                    paintBar();
                }
            });

            form.on('select(categories)', function(data) {
                // 加载收益曲线
                paintCurve();
                // 加载月柱状图
                paintBar();
            });

            // 加载收益曲线
            paintCurve();
            // 加载月柱状图
            paintBar();
            // 加载当月收益
            loadCurrentMonthProfit();

            function loadCurrentMonthProfit() {
                $.ajax({
                    url: "/get-current-month-profit",
                    success: function(result) {
                        for (var i = 0; i < result.length; i ++) {
                        var html;
                            if (result[i].value < 0) {
                                html = "<div class='layui-row current-month-profit-item'>" + result[i].name + ": <a style='color:green;padding-left:20px'>" + result[i].value.toFixed(2) + "</a></div>";
                            } else {
                                html = "<div class='layui-row current-month-profit-item'>" + result[i].name + ": <a style='color:red;padding-left:20px'>" + result[i].value.toFixed(2) + "</a></div>";
                            }
                            $(".current-month-profit").append(html);
                        }
                    }
                });
            }

            function paintBar() {
                var xData = [];
                var yData = [];
                $.ajax({
                    url: "/get-month-profit?start-date=" + $("#startDate").val() + "&end-date=" + $("#endDate").val() + "&category=" + $("#category").val(),
                    async: false,
                    success: function(result) {
                        for (var i = 0; i < result.length; i ++) {
                            xData.push(result[i].date);
                            yData.push(result[i].value.toFixed(2));
                        }
                    }
                });
                var myChart = echarts.init(document.getElementById("bar"));
                var option = {
                    color: ['#3398DB'],
                    title: {
                        text: "每月收益"
                    },
                    tooltip: {
                        trigger: "axis"
                    },
                    toolbox: {
                        show: true,
                        feature: {
                            magicType: {show: true, type: ['line', 'bar']},
                            saveAsImage: {show: true}
                        }
                    },
                    xAxis: [
                        {
                            type: 'category',
                            data: xData
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value'
                        }
                    ],
                    series: [
                        {
                            name: '收益',
                            type: 'bar',
                            data: yData,
                            markLine: {
                                data: [
                                    {type: 'average', name: '平均值'}
                                ]
                            }
                        }
                    ]
                }
                myChart.setOption(option);
            }

            function paintCurve() {
                var data = [];
                var total;
                $.ajax({
                    url: "/get-curve-data?startDate=" + $("#start-date").val() + "&endDate=" + $("#end-date").val() + "&category=" + $("#category").val(),
                    async: false,
                    success: function(result) {
                        var length = result.length;
                        for (var i = 0; i < length; i ++) {
                            data.push({
                                name: result[i].createDate,
                                value: [result[i].createDate, result[i].sum.toFixed(2)]
                            });
                        }
                        total = result[length - 1].sum;
                    }
                });

                // 渲染曲线
                var myChart = echarts.init(document.getElementById("curve"));
                var option = {
                    title: {
                        text: "累计收益：" + total.toFixed(2)
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            params = params[0];
                            var date = new Date(params.name);
                            return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ':' + params.value[1];
                        },
                        axisPointer: {
                            animation: false
                        }
                    },
                    toolbox: {
                        show: true,
                        feature: {
                            magicType: {show: true, type: ['line', 'bar']},
                            saveAsImage: {show: true}
                        }
                    },
                    xAxis: {
                        type: 'time',
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        type: 'value',
                        boundaryGap: [0, '100%'],
                        splitLine: {
                            show: true
                        }
                    },
                    series: [{
                        name: '累计收益2',
                        type: 'line',
                        color: '#1E90FF',
                        showSymbol: false,
                        hoverAnimation: false,
                        data: data,
                    }]
                };
                myChart.setOption(option);
            }
        });
    </script>
</body>