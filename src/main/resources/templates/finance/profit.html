<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link th:href="@{/layui/css/layui.css}" rel="stylesheet" type="text/css">
    <link th:href="@{/css/profit.css}" rel="stylesheet" type="text/css">
    <script type="text/javascript" th:src="@{/layui/layui.js}"></script>
    <script type="text/javascript" th:src="@{/js/echarts.min.js}"></script>
    <title>Title</title>
</head>
<body>
    <div class="layui-fluid">
        <div class="layui-row layui-col-space12">
            <div class="layui-col-md8">
                <div class="layui-card">
                    <div class="layui-card-header">
                        每日收益曲线
                    </div>
                    <div class="layui-card-body">
                        <div id="curve" style="height:400px;"></div>
                    </div>
                </div>
            </div>
            <div class="layui-col-md4">
                <div class="layui-card">
                    <div class="layui-card-body">
                        <div class="layui-row">
                            <div class="layui-col-xs6">
                                <fieldset class="layui-elem-field">
                                    <legend>总收益</legend>
                                    <div class="layui-field-box total-profit">
                                    </div>
                                </fieldset>
                            </div>
                            <div class="layui-col-xs6">
                                <fieldset class="layui-elem-field">
                                    <legend>复合收益率</legend>
                                    <div class="layui-field-box">
                                        --%
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="layui-card">
                    <div class="layui-card-header">
                        我的投资
                    </div>
                    <div class="layui-card-body my-fund">
                        <table id="my-fund-table" lay-filter="my-fund-table"></table>
                    </div>
                </div>

                <div class="layui-card">
                    <div class="layui-card-header">
                        配置
                        <div class="layui-inline ">
                            <button class="layui-btn layui-btn-sm layui-bg-gray addFund"><i class="layui-icon layui-icon-add-1"></i></button>
                        </div>
                    </div>
                    <div class="layui-card-body">
                        <div id="pie" style="height:250px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        layui.use("table", function(){
            var $ = layui.jquery;
            var table = layui.table;


            // 加载总收益
            totalProfit();
            // 加载我的基金表格
            table.render({
                elem: "#my-fund-table",
                id: "my-fund-table",
                url: "/my-fund",
                skin: "nob",
                cols: [
                    [
                        {
                            field: "fundId",
                            title: "ID",
                            hide:true},
                        {
                            field: "fundName",
                            title: "基金",
                            width: "70%"},
                        {
                            field: "sumProfit",
                            title: "总收益",
                            templet: "<div><a href='#' class='sum-profit'>{{d.sumProfit}}</a></div>",
                            event: "profitDetail"
                        }
                    ]
                ]
            });

            table.on("tool(my-fund-table)", function(obj){
                var fundId = obj.data.fundId;
                if (obj.event == "profitDetail") {
                    layer.open({
                        type: 2,
                        area: ['800px', '500px'],
                        content: "/profit-detail?fundId=" + fundId,
                        cancel: function(index, layero) {
                            curvePaint();
                            table.reload("my-fund-table");
                        }
                    });
                }
            });

            // 加载收益曲线
            curvePaint();

            // 加载比重饼图
            piePaint();

            function piePaint() {
                var data = [];
                var total = 0;

                $.ajax({
                    url: "/percentage",
                    async: false,
                    success: function (result) {
                        for (var key in result) {
                            total = total + result[key];
                            if (key == 0) {
                                data.push({value:result[key], name:'股票基金'});
                            } else if (key == 1) {
                                data.push({value:result[key], name:'债券基金'});
                            } else if (key == 2) {
                                data.push({value:result[key], name:'货币基金'});
                            }
                        }
                    }
                });
                var myChart = echarts.init(document.getElementById("pie"));
                var option = {
                    title : {
                        text: '总额：' + total,
                        x:'left'
                    },
                    tooltip : {
                        trigger: 'item',
                        formatter: "{b}：{c} <br/> {a}：{d}%"
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'right',
                        data: ['股票','基金','股票基金','债券基金','货币基金']
                    },
                    series : [
                        {
                            name: '占比',
                            type: 'pie',
                            radius: [0, '50%'],
                            label: {
                                position: 'inner'
                            },
                            labelLine: {
                                show: false
                            },
                            data: [
                                {value: 335, name: '股票'},
                                {value: 679, name: '基金'}
                            ],
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        },
                        {
                            name: '占比',
                            type: 'pie',
                            radius: ['51%', '70%'],
                            data: [
                                {value: 335, name: '股票'},
                                {value: 310, name: '股票基金'},
                                {value: 234, name: '债券基金'},
                                {value: 135, name: '货币基金'}
                            ],
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }
                    ]
                };
                myChart.setOption(option);
            }

            function curvePaint() {
                var profitSumPerDayList;
                var profit = [];

                $.ajax({
                    url:"/profit-sum-per-day",
                    async: false,
                    success: function(result) {
                        profitSumPerDayList = result;
                    }
                });

                var length = profitSumPerDayList.length;
                for (var i = 0; i < length; i++) {
                    profit.push({
                        name: profitSumPerDayList[i].createDate,
                        value: [profitSumPerDayList[i].createDate, profitSumPerDayList[i].sum]
                    });
                }

                // 渲染每日收益曲线图
                var myChart = echarts.init(document.getElementById("curve"));
                var option = {
                    title: {
                        text: "累计收益"
                    },
                    tooltip: {
                        trigger: 'axis',
                        formatter: function (params) {
                            params = params[0];
                            var date = new Date(params.name);
                            return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ':' + params.value[1];
                        },
                        axisPointer: {
                            animation: false
                        }
                    },
                    xAxis: {
                        type: 'time',
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        type: 'value',
                        boundaryGap: [0, '100%'],
                        splitLine: {
                            show: true
                        }
                    },
                    series: [{
                        name: '累计收益2',
                        type: 'line',
                        color: '#1E90FF',
                        showSymbol: false,
                        hoverAnimation: false,
                        data: profit,
                    }]
                };
                myChart.setOption(option);
            }

            function totalProfit() {
                $.ajax({
                    url: "/get-total-profit",
                    success: function(result) {
                        if (result != null) {
                            $(".total-profit").text(result);
                            if (result < 0) {
                                $(".total-profit").css("color", "green");
                            }

                        }
                    }
                });
            }
        });





    </script>
</body>